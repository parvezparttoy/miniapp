<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telegram Mini App ‚Äî Ads Unlock (Coin Mode)</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Adexium / Axidum ad widget -->
  <script src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>

  <style>
    :root { --bg:#f7f7f8; --card:#fff; --text:#0f172a; --muted:#6b7280; --brand:#111; --ok:#059669; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .title{font-weight:800;font-size:22px;margin:4px 0 2px}
    .sub{color:var(--muted);font-size:12px;margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid #eee;border-radius:16px;padding:12px;display:flex;flex-direction:column}
    .media{width:100%;aspect-ratio:16/9;border-radius:12px;background:#e5e7eb;overflow:hidden;position:relative}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .pill{position:absolute;left:8px;top:8px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:12px}
    .h{font-weight:700;margin:10px 0 2px}
    .desc{color:#475569;font-size:12px;margin-bottom:8px}
    .progress{height:10px;background:#ececec;border-radius:8px;overflow:hidden}
    .bar{height:100%;background:#111;width:0;transition:width .3s}
    .row{display:flex;gap:8px;margin-top:10px}
    .btn{flex:1;padding:10px 12px;border-radius:12px;border:none;font-weight:700}
    .btn.watch{background:var(--brand);color:#fff}
    .btn.watch.disabled{background:#e5e7eb;color:#9ca3af}
    .btn.join{background:#e5e7eb;color:#9ca3af}
    .btn.join.ready{background:var(--ok);color:#fff}
    .foot{color:#9ca3af;font-size:11px;text-align:center;margin-top:14px}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .sheet{width:100%;max-width:480px;background:#fff;border-radius:16px;overflow:hidden}
    .sheethd{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee}
    .close{background:transparent;border:none;font-size:18px}
    .sheetbd{padding:12px}
    .hint{font-size:12px;color:#6b7280;margin-top:6px}
    .act{margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Telegram Mini App</div>
    <div class="sub">‡ßß‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° = ‡ßß‡¶ü‡¶ø coin ‚Ä¢ ‡ßß‡ß¶ coin ‡¶π‡¶≤‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶π‡¶¨‡ßá</div>

    <div class="grid">
      <!-- Card 1 -->
      <div class="card">
        <div class="media">
          <img src="https://t.me/all_api_bot/30" alt="Jannat Toha Vairal Video ü•µ">
          <span class="pill">Today Top ‚Ä¢ üî•</span>
        </div>
        <div class="h">Jannat Toha Vairal Video ü•µ</div>
        <div class="desc">‡¶ú‡¶æ‡¶®‡ßç‡¶®‡¶æ‡¶§ ‡¶§‡ßã‡¶π‡¶æ‡¶∞ ‡¶≠‡¶æ‡¶á‡¶∞‡¶æ‡¶≤ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï üòç</div>
        <div class="progress"><div class="bar" id="bar1"></div></div>
        <div class="row">
          <button id="watchBtn" class="btn watch">Watch Ads (0/10)</button>
          <button id="joinBtn" class="btn join">Join Channel</button>
        </div>
      </div>

      <!-- Card 2 -->
      <div class="card">
        <div class="media">
          <img src="https://t.me/all_api_bot/33" alt="Ridhii TikTok üíó">
          <span class="pill">Recent</span>
        </div>
        <div class="h">Ridhii TikTok üíó</div>
        <div class="desc">‡¶∞‡¶ø‡¶ß‡ßÄ ‡¶Æ‡¶®‡¶ø ‡¶≠‡¶æ‡¶á‡¶∞‡¶æ‡¶≤ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï ü•µ</div>
        <div class="progress"><div class="bar" id="bar2"></div></div>
        <div class="row">
          <button class="btn watch disabled" disabled>Watch Ads (shared)</button>
          <button class="btn join">Join Channel</button>
        </div>
      </div>

      <!-- Card 3 -->
      <div class="card">
        <div class="media">
          <img src="https://t.me/all_api_bot/34" alt="Era Moni TikTok üíó">
          <span class="pill">Recent</span>
        </div>
        <div class="h">Era Moni TikTok üíó</div>
        <div class="desc">‡¶á‡¶∞‡¶æ ‡¶Æ‡¶®‡¶ø ‡¶≠‡¶æ‡¶á‡¶Ø‡¶º‡ßá‡¶∞ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï üòçüí¶</div>
        <div class="progress"><div class="bar" id="bar3"></div></div>
        <div class="row">
          <button class="btn watch disabled" disabled>Watch Ads (shared)</button>
          <button class="btn join">Join Channel</button>
        </div>
      </div>
    </div>

    <div class="foot">Coin Mode ‚Ä¢ ‡ßß ad = ‡ßß coin ‚Ä¢ ‡ßß‡ß¶ coin = unlock</div>
  </div>

  <!-- Interstitial Modal -->
  <div class="modal" id="adModal">
    <div class="sheet">
      <div class="sheethd">
        <div style="font-weight:700">Sponsored</div>
        <button class="close" id="closeModal">‚úï</button>
      </div>
      <div class="sheetbd">
        <!-- Adexium interstitial auto-overlays; container kept for future inline formats -->
        <div id="ax-reward-container" style="display:none"></div>
        <button id="claimBtn" class="btn act" disabled>Close & Claim (+1 coin)</button>
        <div class="hint">Ad ‡¶ö‡¶≤‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶´‡ßã‡¶ï‡¶æ‡¶∏‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® ‚Ä¢ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶§‡ßá ‡¶¨‡¶æ‡¶ï‡¶ø: <b id="left">20</b>s</div>
      </div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const REQUIRED_COINS = 10; // ‡ßß‡ß¶‡¶ü‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° = ‡¶Ü‡¶®‡¶≤‡¶ï
  const JOIN_URL = "https://t.me/+JQdsBNK6nE1kNTg1";
  const ADEXIUM_WID = "a44bfe22-11d8-4be8-8E23-ec913119bcca"; // ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ wid
  // ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá URL ‡¶¶‡¶æ‡¶ì; ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá "" ‡¶∞‡¶æ‡¶ñ‡¶≤‡ßá localStorage fallback ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá‡•§
  const API_BASE = "";

  // ========= TELEGRAM =========
  const tg = window.Telegram?.WebApp || null;
  try { tg?.expand?.(); tg?.ready?.(); tg?.MainButton?.hide?.(); } catch(e){}
  const userId = tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "anon";
  const storeKey = `tma_coins_${userId}`;

  // ========= STATE =========
  let coins = Number(localStorage.getItem(storeKey) || "0");
  let timer = null, left = 20, focused = true;

  // ========= UI HOOKS =========
  const bars = [document.getElementById("bar1"), document.getElementById("bar2"), document.getElementById("bar3")];
  const watchBtn = document.getElementById("watchBtn");
  const joinBtn  = document.getElementById("joinBtn");
  const modal  = document.getElementById("adModal");
  const closeModal = document.getElementById("closeModal");
  const claimBtn = document.getElementById("claimBtn");
  const leftEl = document.getElementById("left");

  function pct(){ return Math.min(100, Math.round((coins / REQUIRED_COINS) * 100)); }
  function render(){
    bars.forEach(b => b.style.width = pct() + "%");
    watchBtn.textContent = `Watch Ads (${Math.min(coins, REQUIRED_COINS)}/${REQUIRED_COINS})`;
    const unlocked = coins >= REQUIRED_COINS;
    watchBtn.classList.toggle("disabled", unlocked);
    watchBtn.disabled = unlocked;
    joinBtn.classList.toggle("ready", unlocked);
  }
  render();

  // ========= SERVER FALLBACK REWARD =========
  async function rewardServerFallback(){
    if (!API_BASE) { coins = Math.min(REQUIRED_COINS, coins + 1); localStorage.setItem(storeKey, coins); render(); return; }
    try {
      const r = await fetch(API_BASE + "/api/reward", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData: tg?.initData })
      });
      const j = await r.json();
      if (j?.ok) {
        coins = Math.min(REQUIRED_COINS, coins + 1);
        localStorage.setItem(storeKey, coins);
        render();
      } else {
        coins = Math.min(REQUIRED_COINS, coins + 1);
        localStorage.setItem(storeKey, coins);
        render();
      }
    } catch(e){
      coins = Math.min(REQUIRED_COINS, coins + 1);
      localStorage.setItem(storeKey, coins);
      render();
    }
  }

  function openInterstitial(){
    // Timer + modal
    left = 20; focused = true;
    leftEl.textContent = left;
    claimBtn.disabled = true;
    modal.style.display = "flex";

    const onFocus = () => focused = true;
    const onBlur  = () => focused = false;
    window.addEventListener("focus", onFocus);
    window.addEventListener("blur", onBlur);

    // Adexium interstitial
    try{
      if (window.AdexiumWidget) {
        const ax = new window.AdexiumWidget({ wid: ADEXIUM_WID, adFormat: "interstitial" });
        ax.autoMode();
      }
    }catch(e){ console.log("Adexium init error", e); }

    timer = setInterval(()=>{
      if (left > 0 && focused) {
        left -= 1; leftEl.textContent = left;
        if (left <= 0) { claimBtn.disabled = false; }
      }
    }, 1000);

    const cleanup = ()=>{
      clearInterval(timer); timer = null;
      window.removeEventListener("focus", onFocus);
      window.removeEventListener("blur", onBlur);
      modal.style.display = "none";
    };

    closeModal.onclick = cleanup;
    claimBtn.onclick = async ()=>{ await rewardServerFallback(); cleanup(); };
  }

  watchBtn.onclick = openInterstitial;
  joinBtn.onclick  = ()=>{
    if (coins < REQUIRED_COINS) return;
    if (tg?.openTelegramLink) tg.openTelegramLink(JOIN_URL);
    else window.open(JOIN_URL, "_blank");
  };

  // Optional: pull existing count from server (if API_BASE set)
  (async function bootstrapSync(){
    if (!API_BASE || userId === "anon") return;
    try{
      const v = await fetch(API_BASE + "/api/verify-initdata", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData: tg?.initData })
      }).then(r=>r.json());
      if (v?.ok) {
        const s = await fetch(API_BASE + "/api/stats?user_id=" + userId).then(r=>r.json());
        if (s?.ok && typeof s.views === "number") {
          coins = Math.min(REQUIRED_COINS, Number(s.views));
          localStorage.setItem(storeKey, coins);
          render();
        }
      }
    }catch(e){}
  })();
</script>
</body>
  </html>
