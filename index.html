// server.js â€” Safe SMS sender (whitelist + rate limits)
// npm i express body-parser node-fetch rate-limiter-flexible dotenv
require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const fetch = require('node-fetch');
const { RateLimiterMemory } = require('rate-limiter-flexible');

const app = express();
app.use(bodyParser.json());

// ===== CONFIG =====
const WHITELIST = new Set([
  '+8801YOURNUMBER', // put only your test numbers here
  // '+8801ANOTHER'
]);

const ADMIN_SECRET = process.env.ADMIN_SECRET || 'change-this-in-prod';

// rate limit: 1 SMS per phone per 60s
const perNumberLimiter = new RateLimiterMemory({ points: 1, duration: 60 });
// global limiter: e.g., 5 SMS per minute overall
const globalLimiter = new RateLimiterMemory({ points: 5, duration: 60 });

// provider config (put real values in .env)
const SMS_API_URL = process.env.SMS_API_URL || '';
const SMS_API_KEY = process.env.SMS_API_KEY || '';
const SMS_SENDER  = process.env.SMS_SENDER || 'TEST';

// ===== provider send (example generic) =====
async function sendSmsViaProvider(to, text) {
  // IMPORTANT: customize for your provider
  if(!SMS_API_URL || !SMS_API_KEY) {
    // in test, just simulate
    console.log('[SIM] send to', to, text);
    return { simulated: true };
  }

  const resp = await fetch(SMS_API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${SMS_API_KEY}`
    },
    body: JSON.stringify({
      to, from: SMS_SENDER, message: text
    })
  });

  if(!resp.ok) {
    const txt = await resp.text();
    throw new Error('Provider error: ' + txt);
  }
  return resp.json();
}

// ===== Admin send endpoint (whitelist only, rate-limited) =====
app.post('/admin/send-to-whitelist', async (req, res) => {
  // Protect with admin secret
  const secret = req.headers['x-admin-secret'];
  if(secret !== ADMIN_SECRET) return res.status(401).json({ error: 'Unauthorized' });

  const phone = (req.body.phone || '').trim();
  const message = (req.body.message || '').trim();
  if(!phone || !message) return res.status(400).json({ error: 'phone and message required' });

  if(!WHITELIST.has(phone)) return res.status(403).json({ error: 'Phone not whitelisted' });

  try {
    // rate limit checks
    await perNumberLimiter.consume(phone);
    await globalLimiter.consume('global');

    // send ONE SMS (no loops)
    const r = await sendSmsViaProvider(phone, message);
    return res.json({ ok: true, provider: r });
  } catch (err) {
    console.error('send error', err);
    return res.status(500).json({ ok: false, error: String(err) });
  }
});

// health
app.get('/', (req,res)=> res.send('Safe SMS test hub running'));

const PORT = process.env.PORT || 3000;
app.listen(PORT, ()=> console.log('listening', PORT));
