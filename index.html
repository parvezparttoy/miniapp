<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telegram Mini App ‚Äî Ads Unlock (Per-Card)</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Adexium / Axidum ad widget -->
  <script src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>

  <style>
    :root { --bg:#f7f7f8; --card:#fff; --text:#0f172a; --muted:#6b7280; --brand:#111; --ok:#059669; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .title{font-weight:800;font-size:22px;margin:4px 0 2px}
    .sub{color:var(--muted);font-size:12px;margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid #eee;border-radius:16px;padding:12px;display:flex;flex-direction:column}
    .media{width:100%;aspect-ratio:16/9;border-radius:12px;background:#e5e7eb;overflow:hidden;position:relative}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .pill{position:absolute;left:8px;top:8px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:12px}
    .h{font-weight:700;margin:10px 0 2px}
    .desc{color:#475569;font-size:12px;margin-bottom:8px}
    .progress{height:10px;background:#ececec;border-radius:8px;overflow:hidden}
    .bar{height:100%;background:#111;width:0;transition:width .3s}
    .row{display:flex;gap:8px;margin-top:10px}
    .btn{flex:1;padding:10px 12px;border-radius:12px;border:none;font-weight:700}
    .btn.watch{background:var(--brand);color:#fff}
    .btn.watch.disabled{background:#e5e7eb;color:#9ca3af}
    .btn.join{background:#e5e7eb;color:#9ca3af}
    .btn.join.ready{background:var(--ok);color:#fff}
    .foot{color:#9ca3af;font-size:11px;text-align:center;margin-top:14px}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .sheet{width:100%;max-width:480px;background:#fff;border-radius:16px;overflow:hidden}
    .sheethd{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee}
    .close{background:transparent;border:none;font-size:18px}
    .sheetbd{padding:12px}
    .hint{font-size:12px;color:#6b7280;margin-top:6px}
    .act{margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Telegram Mini App</div>
    <div class="sub">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶™‡ßç‡¶∞‡¶ó‡ßç‡¶∞‡ßá‡¶∏ ‚Ä¢ ‡ßß ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° = ‡ßß coin ‚Ä¢ ‡ßß‡ß¶ coin ‡¶π‡¶≤‡ßá ‡¶ê ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ Join ‡¶Ü‡¶®‡¶≤‡¶ï</div>

    <div id="cards" class="grid"></div>

    <div class="foot">Adexium integrated ‚Ä¢ Coins are per-card</div>
  </div>

  <!-- Interstitial Modal -->
  <div class="modal" id="adModal">
    <div class="sheet">
      <div class="sheethd">
        <div style="font-weight:700">Sponsored</div>
        <button class="close" id="closeModal">‚úï</button>
      </div>
      <div class="sheetbd">
        <!-- Adexium interstitial auto-overlays; container kept for inline formats -->
        <div id="ax-reward-container" style="display:none"></div>
        <button id="claimBtn" class="btn act" disabled>Close & Claim (+1 coin)</button>
        <div class="hint">Ad ‡¶ö‡¶≤‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶´‡ßã‡¶ï‡¶æ‡¶∏‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® ‚Ä¢ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶§‡ßá ‡¶¨‡¶æ‡¶ï‡¶ø: <b id="left">20</b>s</div>
      </div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const REQUIRED_COINS = 10;
  const JOIN_URL = "https://t.me/+JQdsBNK6nE1kNTg1";
  const ADEXIUM_WID = "a44bfe22-11d8-4be8-8E23-ec913119bcca";
  const API_BASE = ""; // optional server, keep "" for local-only

  // Posts data (‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡ß©‡¶ü‡¶æ)
  const POSTS = [
    {
      id: "card1",
      photoPage: "https://t.me/all_api_bot/30",
      title: "Jannat Toha Vairal Video ü•µ",
      desc: "‡¶ú‡¶æ‡¶®‡ßç‡¶®‡¶æ‡¶§ ‡¶§‡ßã‡¶π‡¶æ‡¶∞ ‡¶≠‡¶æ‡¶á‡¶∞‡¶æ‡¶≤ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï üòç",
      badge: "Today Top ‚Ä¢ üî•"
    },
    {
      id: "card2",
      photoPage: "https://t.me/all_api_bot/33",
      title: "Ridhii TikTok üíó",
      desc: "‡¶∞‡¶ø‡¶ß‡ßÄ ‡¶Æ‡¶®‡¶ø ‡¶≠‡¶æ‡¶á‡¶∞‡¶æ‡¶≤ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï ü•µ",
      badge: "Recent"
    },
    {
      id: "card3",
      photoPage: "https://t.me/all_api_bot/34",
      title: "Era Moni TikTok üíó",
      desc: "‡¶á‡¶∞‡¶æ ‡¶Æ‡¶®‡¶ø ‡¶≠‡¶æ‡¶á‡¶Ø‡¶º‡ßá‡¶∞ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï üòçüí¶",
      badge: "Recent"
    }
  ];

  // ========= TELEGRAM =========
  const tg = window.Telegram?.WebApp || null;
  try { tg?.expand?.(); tg?.ready?.(); tg?.MainButton?.hide?.(); } catch(e){}
  const userId = tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "anon";

  // ========= IMAGE RESOLVER (loads og:image via CORS-safe proxy) =========
  async function resolveOgImage(url){
    try{
      const proxyUrl = "https://r.jina.ai/http://" + url.replace(/^https?:\/\//,'');
      const html = await fetch(proxyUrl).then(r=>r.text());
      const m = html.match(/<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["']/i);
      if(m && m[1]) return m[1];
    }catch(e){}
    return ""; // fallback: blank (gray box)
  }

  // ========= RENDER CARDS =========
  const elCards = document.getElementById("cards");
  function pct(v){ return Math.min(100, Math.round((v / REQUIRED_COINS) * 100)); }

  function getStoreKey(cardId){ return `tma_coins_${userId}_${cardId}`; }

  function renderCard(post){
    const coins = Number(localStorage.getItem(getStoreKey(post.id) ) || "0");
    const unlocked = coins >= REQUIRED_COINS;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="media">
        <img id="${post.id}_img" alt="${post.title}">
        <span class="pill">${post.badge}</span>
      </div>
      <div class="h">${post.title}</div>
      <div class="desc">${post.desc}</div>
      <div class="progress"><div class="bar" id="${post.id}_bar" style="width:${pct(coins)}%"></div></div>
      <div class="row">
        <button id="${post.id}_watch" class="btn watch ${unlocked?'disabled':''}" ${unlocked?'disabled':''}>
          Watch Ads (${Math.min(coins,REQUIRED_COINS)}/${REQUIRED_COINS})
        </button>
        <button id="${post.id}_join" class="btn join ${unlocked?'ready':''}" ${unlocked?'':'disabled'}>
          Join Channel
        </button>
      </div>
    `;
    elCards.appendChild(div);

    // load image via og:image
    resolveOgImage(post.photoPage).then(src=>{
      const img = document.getElementById(`${post.id}_img`);
      if(src){ img.src = src; } else { img.style.display = "none"; }
    });

    // handlers
    const bar = document.getElementById(`${post.id}_bar`);
    const watchBtn = document.getElementById(`${post.id}_watch`);
    const joinBtn  = document.getElementById(`${post.id}_join`);

    watchBtn.onclick = () => openInterstitial(post.id, bar, watchBtn, joinBtn);
    joinBtn.onclick = () => {
      const cur = Number(localStorage.getItem(getStoreKey(post.id)) || "0");
      if (cur < REQUIRED_COINS) return;
      if (tg?.openTelegramLink) tg.openTelegramLink(JOIN_URL);
      else window.open(JOIN_URL, "_blank");
    };
  }

  POSTS.forEach(renderCard);

  // ========= INTERSTITIAL / REWARD (per-card) =========
  const modal  = document.getElementById("adModal");
  const closeModal = document.getElementById("closeModal");
  const claimBtn = document.getElementById("claimBtn");
  const leftEl = document.getElementById("left");

  let timer = null, left = 20, focused = true;
  let active = { cardId: null, bar:null, watchBtn:null, joinBtn:null };

  function updateUI(cardId, barEl, watchEl, joinEl){
    const coins = Number(localStorage.getItem(getStoreKey(cardId)) || "0");
    barEl.style.width = pct(coins) + "%";
    watchEl.textContent = `Watch Ads (${Math.min(coins,REQUIRED_COINS)}/${REQUIRED_COINS})`;
    const unlocked = coins >= REQUIRED_COINS;
    watchEl.classList.toggle("disabled", unlocked);
    watchEl.disabled = unlocked;
    joinEl.classList.toggle("ready", unlocked);
    joinEl.disabled = !unlocked;
  }

  async function rewardServerFallback(cardId){
    // server optional; local fallback always works
    if (!API_BASE) {
      const key = getStoreKey(cardId);
      const cur = Number(localStorage.getItem(key) || "0");
      const next = Math.min(REQUIRED_COINS, cur + 1);
      localStorage.setItem(key, next);
      updateUI(cardId, active.bar, active.watchBtn, active.joinBtn);
      return;
    }
    try{
      const r = await fetch(API_BASE + "/api/reward", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ initData: tg?.initData })
      });
      await r.json();
    }catch(e){}
    const key = getStoreKey(cardId);
    const cur = Number(localStorage.getItem(key) || "0");
    const next = Math.min(REQUIRED_COINS, cur + 1);
    localStorage.setItem(key, next);
    updateUI(cardId, active.bar, active.watchBtn, active.joinBtn);
  }

  function openInterstitial(cardId, barEl, watchEl, joinEl){
    active = { cardId, bar:barEl, watchBtn:watchEl, joinBtn:joinEl };
    left = 20; focused = true;
    leftEl.textContent = left;
    claimBtn.disabled = true;
    modal.style.display = "flex";

    const onFocus = () => focused = true;
    const onBlur  = () => focused = false;
    window.addEventListener("focus", onFocus);
    window.addEventListener("blur", onBlur);

    try{
      if (window.AdexiumWidget) {
        const ax = new window.AdexiumWidget({ wid: ADEXIUM_WID, adFormat: "interstitial" });
        ax.autoMode();
      }
    }catch(e){ console.log("Adexium init error", e); }

    timer = setInterval(()=>{
      if (left > 0 && focused) {
        left -= 1; leftEl.textContent = left;
        if (left <= 0) { claimBtn.disabled = false; }
      }
    }, 1000);

    const cleanup = ()=>{
      clearInterval(timer); timer = null;
      window.removeEventListener("focus", onFocus);
      window.removeEventListener("blur", onBlur);
      modal.style.display = "none";
    };

    closeModal.onclick = cleanup;
    claimBtn.onclick = async ()=>{ await rewardServerFallback(cardId); cleanup(); };
  }
</script>
</body>
  </html>
